<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>小程序直播间的基础架构和功能优化</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/black.css" id="theme">
		<!-- <link rel="stylesheet" href="dist/theme/white.css" id="theme"> -->

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css" id="highlight-theme">
		<style>
			.reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5, .reveal h6 {
				text-transform: initial;
			}

			.reveal p {
				text-align: left;
			}

			.reveal blockquote {
				width: 95%;
			}
		</style>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section data-markdown>
					# 小程序直播间
					## 基础架构和功能优化
					###### 小溪里
					###### 2020-07-08
				</section>
				<section data-markdown>
					## 知识点 
					* 小程序业务介绍
					* `socket` 基础知识
					* `socket-service` 的连接机制
						* 断网重连的bug
					* 播放器的设计
					* 消息监听
				</section>
				<section>
					<section data-markdown>
						## 小程序功能简介
					</section>
					<section data-markdown>
						### 我的课程列表
						
						* 账号登录
						* 购买后的课程列表
						
						###### ![图片](./img/introduction-1.png)

					</section>
					<section data-markdown>
						### 网师主页
						
						内嵌 web 端网师主页
						
						* 需要隐藏 Web端价格标签，如价格、优惠活动等
						
						###### ![图片](./img/introduction-2.png)
					</section>
					<section data-markdown></section>
					<section data-markdown></section>
				</section>
				<section>
					<section data-markdown>
						# Socket连接及 <br />Socket-service 服务
					</section>
					<section data-markdown>
						### Socket 连接原理
						
						* HTTP 连接：API 请求
						* 长轮询：订单状态查询
						* WebSocket 连接：聊天室
						
						###### ![图片](./img/socket-1.png)
					</section>
					<section data-markdown>
						### 主要连接顺序
						
						1. 创建 `socket` 连接，以 `wss` 协议
						2. 验证 `service-token` 信息
						3. 请求指令、回应指令
							* 获取上麦人数、是否禁言、在线人数等
							* 监听多种消息类型，如普通消息、上麦、送鲜花等
						
						###### ![图片](./img/socket-2.png)
					</section>
					<section data-markdown>
						### 连接库
						
						基于 `socket.io` 实现，有 `socket.io-server` 服务端和 `socket.io-client` 客户端版本
						
						Web端使用 `socket.io-client` 1.4.6 版
						
						小程序端用的 `wxapp-socket-io` 1.0.0 版，特点为编译后未压缩版本大小为 60 k，使用单socket连接，其核心逻辑为 `engine.js` 中有 `wx.connectSocket` 和 `wx.closeSocket` 的单任务连接机制
					</section>
					<section data-markdown>
						### 连接库的疑问
						为何不使用 `wxapp-socket-io` 的最新版呢？
						
						最新版实现的原理是基于`socket.io-client` 的 2.3.6版本，将编译后未压缩版本大小为300k左右，且在分析namespace时会多一个 “,”，
						
						
						###### ![图片](./img/socket-3.png)
						
						```javascript [3]
						// 错误
						/group123456,
						/group123456,,invalid namespace
						```
					</section>
					<section data-markdown>
						### 连接初始代码
						
						1、io 连接 `wss.cctalk.com:8000/group123456` 其中 `wss.cctalk.com:8000` 为socket连接地址，`group123456` 为命名空间（群聊房间）
						
						```javascript
						// 调用时的配置
						const socket = new Socket({
							store,
							userId: userInfo.userId,
							actions: liveActions,
							videoId: videoInfo.videoId,
							groupId: videoInfo.groupId
						})
						```
					</section>
					<section data-markdown>
						<textarea data-template>

							```javascript
							// 获取wss链接
							export async function getSocketServer(groupId) {
								try {
									const res = await getWssInfo()
									return `wss://${(res.httpsHost).trim()}:8000/group${groupId}`
								} catch (e) {
									wsslogError(e, '获取 wss 地址失败')
									return null
								}
							}
							```
							```json
							 {
								"httpsHost": "swss.hjapi.com",
								"wssHost": "wss.cctalk.com",
								"wssPort": "8000"
							}
							```
							```javascript
								// 实际连接的核心代码
								const server = getSocketServer(this.groupId)
								this.socket = io(server, {
								// 重连间隔
								reconnectionDelay: 50000,
								// 最大重连尝试次数
								reconnectionAttempts: 5,
							})
							```
						</textarea>
					</section>
					<section data-markdown>
						2、获取 `service-token` ，校验token，此时才会认为 `socket` 登录成功
						
						```javascript
						const data = await this.actions.user.getSocketToken()
						// 开始验证 token，当后续验证 token 通过时，才算登录成功
						this.sendCMD(__code.SCMD_LOGIN_VERIFY_TOKEN_REQ, { content: data.token }) 
						```
						```json
						{
							"blackReason": "",
							"nickName": "xiaoxili22",
							"releaseTime": 0,
							"token": "6680462445615xxxxxx",
							"userId": 65875530,
							"userName": "xiaoxili22"
						}
						```
						> 直播间socket连接的机制，命名空间、token校验、多次重连机制、10秒心跳重连

					</section>
					<section data-markdown>
						### 断网重连bug
						
						bug表现：在用户断网后再次重连后，用户会被从参与列表中自动推出
					</section>
					<section data-markdown>
						#### 怀疑表现1
						
						微信开发者工具没有问题，但小程序上就有问题
						
						CCtalk web端直播间使用的每隔10秒请求一次群成员数量以此来判断是否连接成功
						
						沪江网校的方案为每隔10秒会关闭Socket连接，再重新连接一次
						
						**但经过多次尝试，依然无效**
						
						> 客户端断开用户连接的时间为2分钟，2分钟内重连成功后不会将用户从用户列表移除。
					</section>
					<section data-markdown>
						<textarea data-template>
							#### 心跳重连的示例代码

							```js [9-12,16-23]
							wx.getNetworkType({
								success: function (res) {
									// 返回网络类型, 有效值：
									// wifi/2g/3g/4g/unknown(Android下不常见的网络类型)/(无网络)
									const networkType = res.networkType;
									if (networkType === 'none') {
										console.log('网络中断，聊天服务异常');
										//重置
										noNetwork = true;
										self.socket && self.socket.disconnect();
										self.closeAgora();
										wx.closeSocket();
										return;
									}
									//之前有过没有网络的情况
									if (noNetwork) {
										if (self.socket) {
											self.socket.disconnect();
											wx.closeSocket();
										}
										setTimeout(() => {
											self.connect();
										}, 1000);
									}
								}
							});
							```
						</textarea>
					</section>
					<section data-markdown>
						#### 怀疑表现2
						
						但通过测试，iPhone手机的 Safari 浏览器也有类似的bug，怀疑为 Sever 问题，（电脑端没有这个问题）
						
						表现为：
						
						* 直接断开网络后，参与成员在80秒左右会自动离开
						* 25秒断开网络后，参与成员在80秒左右会自动离开
						</section>
						<section data-markdown>
						Server同学在解决问题后，给出一下分析：
						
						* 存在多个wss的情况下，会出现不能保证顺序执行用户离开再进入，会变成先进入再离开，所以断线后就连不上了。
						* 对单次登录做了唯一uuid记录，离开的时候需要匹配uuid，否则直接不处理此次离开（认为非法）
						* 这样先收到进入（新的uuid），再收到离开（老的uuid）。因为老的uuid跟新的uuid不匹配，所以做丢弃处理
					</section>
				</section>
				<section>
					<section data-markdown>
						## 播放器
					</section>
					<section data-markdown>
						**小程序端**
						
						`live-player` 的 src 支持 rtmp 格式，
						
						首次使用 `videoInfo` 里面的 rtmp 地址，但也支持通过 `Socket` 指令来更换 rtmp 地址
						
						**Web端**
						
						HLS的 m3u8 方式，简单来说就是每次传递视频的一小块。
					</section>
					<section data-markdown>
						### 同层渲染
						
						LivePlayer 在小程序基础库v2.9.1 起支持同层渲染。
						> CCtalk 课程小程序的最低基础库限制为 V2.8.0

						但想覆盖住全屏后的 `LivePlayer`，就需要使用 ``
						![图片](https://uploader.shimo.im/f/aIkRsEhu2CP0drr3.png!thumbnail)
						
						安卓手机上即使是最新版小程序基础库，还是会出现“静音”和“全屏”按钮按钮显示不出来，原因为嵌套不合理。
					</section>
					<section data-markdown>
					</section>
					<section data-markdown>
					</section>
					<section data-markdown>
					</section>
					<section data-markdown>
					</section>
					<section data-markdown>
					</section>
					<section data-markdown>
					</section>
					<section data-markdown>
					</section>
				</section>
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
			});
		</script>
	</body>
</html>
